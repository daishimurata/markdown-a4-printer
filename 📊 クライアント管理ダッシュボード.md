# 📊 クライアント管理ダッシュボード

> **最終更新**: 2025-06-11  
> **対象データ**: ClientFaceSheetsフォルダ

## 🎯 クライアント基本情報

### 📋 全クライアント一覧

```dataviewjs
// Scripts/client_facesheet_dataview_queries.js からコードを実行
const FOLDER_PATH = "ClientFaceSheets";
const EXCLUDE_FILES = ["dbfolder.json", "README.md", "フェイスシートテンプレート.md"];

function formatDate(dateStr) {
    if (!dateStr) return "";
    const date = new Date(dateStr);
    return date.toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    });
}

function getStatusColor(status) {
    const colors = {
        "active": "#4CAF50",
        "trial": "#2196F3", 
        "considering": "#FF9800",
        "ended": "#9E9E9E"
    };
    return colors[status] || "#9E9E9E";
}

function getStatusLabel(status) {
    const labels = {
        "active": "利用中",
        "trial": "体験中",
        "considering": "検討中", 
        "ended": "利用終了"
    };
    return labels[status] || status;
}

function getGenderLabel(gender) {
    return gender === "male" ? "男性" : "女性";
}

function getDisabilityClassLabel(disabilityClass) {
    const labels = {
        "class1": "区分1",
        "class2": "区分2", 
        "class3": "区分3",
        "class4": "区分4",
        "class5": "区分5",
        "class6": "区分6"
    };
    return labels[disabilityClass] || disabilityClass;
}

function getResidenceTypeLabel(residenceType) {
    const labels = {
        "gh": "グループホーム",
        "home": "自宅",
        "facility": "施設入所",
        "other": "その他"
    };
    return labels[residenceType] || residenceType;
}

// クライアント一覧表示
const clients = dv.pages(`"${FOLDER_PATH}"`)
    .where(p => !EXCLUDE_FILES.some(file => p.file.name.includes(file.replace('.md', ''))))
    .sort(p => p.client_name);

if (clients.length === 0) {
    dv.paragraph("📋 クライアント情報が見つかりません。");
} else {
    const tableData = clients.map(client => [
        `[[${client.file.name}|${client.client_name || "未入力"}]]`,
        client.age ? `${client.age}歳` : "",
        getGenderLabel(client.gender),
        getDisabilityClassLabel(client.disability_class),
        getResidenceTypeLabel(client.residence_type),
        `<span style="color: ${getStatusColor(client.status)}; font-weight: bold;">${getStatusLabel(client.status)}</span>`,
        formatDate(client.start_date),
        formatDate(client.last_updated)
    ]);
    
    dv.table(
        ["氏名", "年齢", "性別", "障害支援区分", "居住形態", "利用状況", "利用開始日", "最終更新"],
        tableData
    );
}
```

---

## 📊 利用状況別サマリー

```dataviewjs
// 利用状況別サマリー
const clients = dv.pages(`"${FOLDER_PATH}"`)
    .where(p => !EXCLUDE_FILES.some(file => p.file.name.includes(file.replace('.md', ''))));

const statusCounts = {};
clients.forEach(client => {
    const status = client.status || "未設定";
    statusCounts[status] = (statusCounts[status] || 0) + 1;
});

const summaryData = Object.entries(statusCounts).map(([status, count]) => [
    `<span style="color: ${getStatusColor(status)}; font-weight: bold;">${getStatusLabel(status)}</span>`,
    `${count}名`,
    `${Math.round((count / clients.length) * 100)}%`
]);

dv.table(["利用状況", "人数", "割合"], summaryData);
```

---

## 🏥 医療機関別クライアント一覧

```dataviewjs
// 医療機関別一覧
const clientsWithMedical = dv.pages(`"${FOLDER_PATH}"`)
    .where(p => !EXCLUDE_FILES.some(file => p.file.name.includes(file.replace('.md', ''))))
    .where(p => p.medical_institution);

if (clientsWithMedical.length === 0) {
    dv.paragraph("🏥 医療機関情報が登録されたクライアントがいません。");
} else {
    const institutionGroups = {};
    clientsWithMedical.forEach(client => {
        const institution = client.medical_institution || "未登録";
        if (!institutionGroups[institution]) {
            institutionGroups[institution] = [];
        }
        institutionGroups[institution].push(client);
    });
    
    Object.entries(institutionGroups).forEach(([institution, clientList]) => {
        dv.header(4, `${institution} (${clientList.length}名)`);
        
        const tableData = clientList.map(client => [
            `[[${client.file.name}|${client.client_name}]]`,
            client.main_doctor || "",
            client.visit_frequency || "",
            client.clinic_phone || ""
        ]);
        
        dv.table(
            ["氏名", "主治医", "受診頻度", "電話番号"],
            tableData
        );
    });
}
```

---

## 💰 経済状況サマリー

```dataviewjs
// 経済状況分析
const clientsWithEconomic = dv.pages(`"${FOLDER_PATH}"`)
    .where(p => !EXCLUDE_FILES.some(file => p.file.name.includes(file.replace('.md', ''))))
    .where(p => p.pension_amount || p.savings_amount || p.gh_fee);

if (clientsWithEconomic.length === 0) {
    dv.paragraph("💰 経済情報が登録されたクライアントがいません。");
} else {
    dv.header(4, `経済状況が登録されているクライアント (${clientsWithEconomic.length}名)`);
    
    const economicData = clientsWithEconomic.map(client => [
        `[[${client.file.name}|${client.client_name}]]`,
        client.pension_amount ? `${client.pension_amount.toLocaleString()}円/月` : "",
        client.savings_amount ? `約${client.savings_amount.toLocaleString()}円` : "",
        client.gh_fee ? `${client.gh_fee.toLocaleString()}円/月` : "",
        getStatusLabel(client.status)
    ]);
    
    dv.table(
        ["氏名", "障害年金", "預金額", "GH利用料", "利用状況"],
        economicData
    );
}
```

---

## 📅 最近の更新状況

```dataviewjs
// 最近更新されたクライアント（30日以内）
const thirtyDaysAgo = new Date();
thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

const recentUpdates = dv.pages(`"${FOLDER_PATH}"`)
    .where(p => !EXCLUDE_FILES.some(file => p.file.name.includes(file.replace('.md', ''))))
    .where(p => p.last_updated && new Date(p.last_updated) >= thirtyDaysAgo)
    .sort(p => p.last_updated, 'desc');

if (recentUpdates.length === 0) {
    dv.paragraph("📅 過去30日間に更新されたクライアント情報はありません。");
} else {
    dv.header(4, `最近更新されたクライアント (${recentUpdates.length}名)`);
    
    const recentData = recentUpdates.map(client => [
        `[[${client.file.name}|${client.client_name}]]`,
        formatDate(client.last_updated),
        `<span style="color: ${getStatusColor(client.status)}; font-weight: bold;">${getStatusLabel(client.status)}</span>`,
        client.medical_institution || ""
    ]);
    
    dv.table(
        ["氏名", "最終更新日", "利用状況", "医療機関"],
        recentData
    );
}
```

---

## 💾 CSV出力機能

```dataviewjs
// CSV出力
const allClients = dv.pages(`"${FOLDER_PATH}"`)
    .where(p => !EXCLUDE_FILES.some(file => p.file.name.includes(file.replace('.md', ''))));

if (allClients.length === 0) {
    dv.paragraph("❌ CSV出力用のデータがありません。");
} else {
    // CSVヘッダー
    const headers = [
        "氏名", "生年月日", "年齢", "性別", "障害支援区分", "住所", "電話番号",
        "居住形態", "利用状況", "利用開始日", "受給者証番号", "医療機関名",
        "主治医", "受診頻度", "療育手帳", "精神疾患", "障害年金", "預金額",
        "GH利用料", "最終更新日"
    ];
    
    // CSVデータ
    const csvData = allClients.map(client => [
        client.client_name || "",
        client.birth_date || "",
        client.age || "",
        getGenderLabel(client.gender),
        getDisabilityClassLabel(client.disability_class),
        client.address || "",
        client.phone || "",
        getResidenceTypeLabel(client.residence_type),
        getStatusLabel(client.status),
        formatDate(client.start_date),
        client.recipient_number || "",
        client.medical_institution || "",
        client.main_doctor || "",
        client.visit_frequency || "",
        client.therapeutic_notebook || "",
        client.mental_illness || "",
        client.pension_amount ? `${client.pension_amount}円/月` : "",
        client.savings_amount ? `約${client.savings_amount}円` : "",
        client.gh_fee ? `${client.gh_fee}円/月` : "",
        formatDate(client.last_updated)
    ]);
    
    // CSV文字列生成
    let csvContent = headers.join(",") + "\n";
    csvData.forEach(row => {
        const escapedRow = row.map(field => 
            typeof field === 'string' && field.includes(',') 
                ? `"${field.replace(/"/g, '""')}"` 
                : field
        );
        csvContent += escapedRow.join(",") + "\n";
    });
    
    dv.paragraph(`📊 **${allClients.length}件のクライアント情報**をCSV形式で出力します。`);
    dv.paragraph("⬇️ 以下のテキストをコピーして、拡張子`.csv`のファイルとして保存してください。");
    
    // CSVデータを表示
    dv.paragraph("```csv\n" + csvContent + "\n```");
    
    // ダウンロード用リンク（参考情報）
    dv.paragraph("💡 **使い方**: 上記のCSVデータをコピーして、メモ帳やExcelに貼り付けて保存してください。");
}
```

---

## 🔍 検索・フィルター

### よく使用される検索例

- **医療機関で検索**: `鈴鹿厚生病院`
- **地域で検索**: `鈴鹿市`
- **主治医で検索**: `大井`
- **利用状況で検索**: 上記の表でフィルター機能を使用

---

## 📋 管理メモ

### 次回チェック項目
- [ ] 新規クライアントの情報入力確認
- [ ] 利用状況の更新が必要なクライアント確認
- [ ] 医療機関情報の最新化
- [ ] CSV出力による定期バックアップ

### システム保守
- [ ] Database Folderプラグインの更新確認
- [ ] テンプレートファイルの見直し
- [ ] データベース設定の最適化

---

**📞 システムサポート**: 技術的な問題や追加機能のご要望がございましたら、お気軽にお問い合わせください。 